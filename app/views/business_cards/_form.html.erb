        <!-- require 'mini_magick' -->
<div class="container">
<section style="margin: 10px;">

<fieldset style="border-radius: 5px; padding: 5px; min-height:150px;">

  <% if current_user %> 


    <%= form_for @business_card, :html => {id: "imageform"}  do |f| %>
      <% if @business_card.errors.any? %>
        <div id="error_explanation">
          <h2><%= pluralize(@business_card.errors.count, "error") %> prohibited this business_card from being saved:</h2>

          <ul>
          <% @business_card.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
          </ul>
        </div>
      <% end %> 


      <%= f.label :image %>
      <%= f.file_field :image, :html => {id: "business_card_image"} %>

      <!-- <input type="hidden" name="canvascontent" id="canvascontent" /> -->

          <br>
          <br>
          <br>
      <span class="glyphicon glyphicon-camera"><input type="submit" id="imageSubmit" name="commit" value="Add Business card"></span> 
      
<!-- create_user.id/ businesscard.id-->

      <% end %>
    <% else %>
    <% link_to sessions_path %>
  <% end %>
<br>

<div id="preview"></div>

<button id="button">Rotate</button>
<!-- <canvas id="c"></canvas> -->

 <script type="text/javascript">
  var imageInput = document.getElementById("business_card_image")
  var imageform = document.getElementById("imageform")
  var preview = document.getElementById("preview")
  function uploadImage(e) {
    console.log(e)
        for (var i = 0; i < imageInput.files.length; i++) {
    var file = imageInput.files[i];
    var imageType = /^image\//;
  
    if (!imageType.test(file.type)) {
      continue;
    }
    
    var img = document.createElement("img");
    img.classList.add("obj");
    img.file = file;
    img.id = "imgPreview"
    img.className = "rotate"+angle;
    img.src = preview.appendChild(img); // Assuming that "preview" is the div output where the content will be displayed.
        

    var reader = new FileReader();
    reader.onload = (function(aImg) { 
      return function(e) { 
      aImg.src = e.target.result; }; 
    })

    (img);
    reader.readAsDataURL(file);

    var angle = 0, img = document.getElementById('imgPreview');
    document.getElementById('button').onclick = function() {
    angle = (angle+90)%360;
}
    
    // var canvas = new fabric.Canvas('c');
    // var imgElement = document.getElementById('imgPreview');
    // console.log(imgElement)
    // var imgInstance = new fabric.Image(imgElement, {
    //   left: 100,
    //   top: 20,
    //   angle: 0,
    //   opacity: 1
    // });

    // var button = document.getElementById("save")
    // button.addEventListener("click", saveUrl);

  // canvas.add("obj");

  // var url = canvas.toDataURL('image/png');
  // $("#c").val(url);
    // fabric.Image
  }


  // imageform.submit();
 }

  imageInput.addEventListener("change", uploadImage);

  function previewImage() {
  console.log("submit")
  return true
  } 

 </script> 

  <script type="text/javascript">


    function saveUrl() {

      var dataURL =  canvas.toDataURL('image/png', 1.0).replace(/^data:image\/(png|jpg);base64,/, "");
      var formData = new FormData();
      formData.append('data_uri', dataURL);
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/business_cards/upload', true);
      xhr.setRequestHeader('Content-Type', 'multipart/form-data');
      xhr.onload = function(){ if (xhr.status !== 200) {alert('Request Failed.')}};
      xhr.send('data_uri='+ dataURL);
      console.log(dataURL)
    }





  </script>

<button id="save">Save Image</button>

</fieldset> 

</div>

